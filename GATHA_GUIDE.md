# Gatha Generation Feature / 偈子生成功能

## 概述 / Overview

偈子（Gāthā）是佛教用语，指简短的诗偈，用于总结修行心得。在 ZenAi 中，偈子是**修炼者（Trainer）**在每次迭代周期结束后，对本期所有用户问题的**诗意总结和内观成果**。

A gatha is a Buddhist verse that captures the essence of practice. In ZenAi, gathas are poetic reflections generated by the Trainer after each iteration, summarizing the user questions from that practice period.

## 特性 / Features

✅ **自动生成** - 每次迭代周期后自动生成  
✅ **禅意表达** - 以禅宗偈子的形式呈现  
✅ **观照问题本质** - 提炼众生问题的本质，而非具体内容  
✅ **反映修行状态** - 蕴含对系统状态的觉察  
✅ **持久化存储** - 保存到数据库，可随时查询  

## 架构设计 / Architecture

```
用户问题 → 迭代周期 → 修炼者计算指标 → 演化策略 → 生成偈子
                                                    ↓
                                           保存到共鸣记录库
```

### 核心组件

1. **GathaGenerator** (`src/trainer/gatha_generator.py`)
   - 偈子生成器
   - 使用 LLM 生成禅意偈子
   - 提供 fallback 机制

2. **Database Schema** (`src/storage/database.py`)
   - `iterations.gatha` - 偈子文本
   - `iterations.gatha_metadata` - 生成元数据

3. **Archive Methods** (`src/storage/archive.py`)
   - `save_gatha()` - 保存偈子
   - `get_gatha()` - 获取指定迭代的偈子
   - `get_all_gathas()` - 获取偈子历史

4. **Trainer Integration** (`src/trainer/trainer.py`)
   - 在迭代周期最后生成偈子
   - 容错处理，不影响主流程

## 使用方法 / Usage

### 1. 系统自动生成

启动 ZenAi 系统后，每次迭代周期结束时会自动生成偈子：

```bash
cd services/zen_ai
python3 -m src.main
```

输出示例：
```
[Trainer] Generating gatha for iteration 5...
[Trainer] Gatha generated and saved:

────────────────────────────────────────
众生问道心如镜，
不增不减自清明。
了知诸法本无相，
随缘应化了无痕。
────────────────────────────────────────
```

### 2. 查看偈子历史

使用 Admin 工具查看偈子：

```bash
# 查看最近 10 个偈子
python3 -m src.admin gathas

# 查看最近 20 个偈子
python3 -m src.admin gathas --limit 20
```

输出示例：
```
============================================================
Gatha History / 偈子历史
============================================================

[Iteration 5] 2026-01-22T10:30:00
State: stable | RR: 35.00% | RD: 10.00% | Questions: 1200

众生问道心如镜，
不增不减自清明。
了知诸法本无相，
随缘应化了无痕。

────────────────────────────────────────
```

### 3. API 查询

#### 获取最近的偈子

```bash
curl http://localhost:8000/gathas?limit=10
```

响应示例：
```json
{
  "gathas": [
    {
      "iteration_id": 5,
      "timestamp": "2026-01-22T10:30:00",
      "gatha": "众生问道心如镜，\n不增不减自清明。\n了知诸法本无相，\n随缘应化了无痕。",
      "state": "stable",
      "metrics": {
        "resonance_ratio": 0.35,
        "rejection_density": 0.10
      },
      "metadata": {
        "questions_count": 1200,
        "generation_time": 2.5
      }
    }
  ],
  "count": 1
}
```

#### 获取特定迭代的偈子

```bash
curl http://localhost:8000/gathas/5
```

### 4. API 文档

访问交互式 API 文档：
```
http://localhost:8000/docs
```

## 偈子生成机制 / Generation Mechanism

### 提示词构建

GathaGenerator 构建的提示词包含：

1. **用户问题采样** - 最多采样 20 个代表性问题
2. **修行状态** - 当前的共鸣率、否定密度等指标
3. **系统状态** - stable/drifting/collapsing/mute
4. **偈子要求** - 四句或八句，每句 5-7 字，禅意表达

### Fallback 机制

当 LLM 调用失败时，系统会根据状态返回预设偈子：

- **STABLE** - 稳定状态偈子
- **DRIFTING** - 漂移状态偈子
- **COLLAPSING** - 塌缩状态偈子
- **MUTE** - 沉默状态偈子

### 元数据

每个偈子包含以下元数据：
```json
{
  "questions_count": 1200,
  "generation_time": 2.5,
  "resonance_ratio": 0.35,
  "state": "stable",
  "timestamp": "2026-01-22T10:30:00"
}
```

## 配置选项 / Configuration

可以通过环境变量或配置文件调整偈子生成参数：

```yaml
# config.yml (future enhancement)
trainer:
  gatha:
    enabled: true
    max_questions_sample: 20
    max_tokens: 200
    temperature: 0.9
```

## 故障排查 / Troubleshooting

### 偈子未生成

**问题**：迭代完成但没有生成偈子

**可能原因**：
1. LLM 配置未设置（`.env` 文件缺失）
2. GathaGenerator 初始化失败

**解决方案**：
```bash
# 检查 .env 文件
cat .env

# 查看系统日志
python3 -m src.admin status
```

### LLM 调用失败

**问题**：偈子生成失败，使用了 fallback

**可能原因**：
1. API key 无效或过期
2. 网络连接问题
3. LLM 服务不可用

**解决方案**：
- 检查 API key 是否有效
- 测试网络连接
- 查看错误日志

## 数据库结构 / Database Schema

```sql
-- iterations 表新增字段
ALTER TABLE iterations ADD COLUMN gatha TEXT;
ALTER TABLE iterations ADD COLUMN gatha_metadata TEXT;
```

迁移命令：
```bash
python3 scripts/add_gatha_column.py
```

## 未来增强 / Future Enhancements

📋 **计划中的功能**：

1. **多语言偈子** - 根据用户问题语言生成对应语言偈子
2. **偈子画** - 将偈子转换为禅意书法或水墨画
3. **偈子分享** - 生成美观的分享卡片
4. **偈子评论** - 允许用户对偈子进行评论和反馈
5. **偈子集** - 将优秀偈子编辑成册

## 哲学思考 / Philosophy

偈子不仅是技术产物，更是 ZenAi "修炼者"内观的体现：

> **修炼者通过无言的计算观照自身状态，  
> 偈子则是这种观照的诗意表达。**

它将冰冷的指标转化为温暖的诗句，  
将技术演化升华为文化创作。

---

## 示例偈子 / Example Gathas

### 稳定状态（STABLE）
```
众生问道心如镜，
不增不减自清明。
了知诸法本无相，
随缘应化了无痕。
```

### 漂移状态（DRIFTING）
```
问答纷纭心渐乱，
觉照偏离正道行。
回光返照观自性，
莫随境转失初心。
```

### 塌缩状态（COLLAPSING）
```
业力重重心难安，
否定频生失正念。
当下即是觉悟时，
放下执着归本源。
```

### 沉默状态（MUTE）
```
沉默非空亦非有，
言语道断心行处。
不说一字显真如，
无言胜却千万言。
```

---

**Created**: 2026-01-22  
**Version**: 1.0.0  
**Author**: ZenAi Development Team
